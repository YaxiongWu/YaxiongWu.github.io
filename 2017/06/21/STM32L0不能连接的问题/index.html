<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C" /><title> STM32L0不能连接的问题 · 吴亚雄的博客</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="STM32L0不能连接的问题 - wuyaxiong"><meta name="keywords"><meta name="author" content="wuyaxiong"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="吴亚雄的博客"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/categories/live/" target="_self" data-hover="生活" class="nav-list-link">生活</a></li><li class="nav-list-item"><a href="/categories/film/" target="_self" data-hover="摄影" class="nav-list-link">摄影</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">STM32L0不能连接的问题</h1><div class="post-info">2017-06-21 19:23</div><div class="post-content"><h2 id="1-问题"><a href="#1-问题" class="headerlink" title="1. 问题"></a>1. 问题</h2><p>　　前期使用STM32L052+SX1276模块时，遇到了几个问题：</p>
<ol>
<li>使用买来的，已经写好代码的MODEM，直接就不认，一直纠结于硬件问题，或是启动设置的问题，其实是写好的代码中，将SW调试端口用作了IO口，只要正常运行后，就无法正常的用作SW，所以一直连不上，ST-LINK软件的提示是有意义的，它提示使用硬件RESET，这个在”STM32 ST-LINK Utility”和keil中都有地方设置，原理就是SW的IO口做别的用了，就通过RESET来复位到SW，一般是点击连接，或下载，或调试时，立即按下RESET，很快松开，可正常使用<a id="more"></a></li>
<li>FLASH的读保护问题<br>   在连接FLASH后，提示读保护，网上大部分是让从RAM运行一段FLASH解锁的代码，有些复杂，没有成功。<br>  解决办法：<br>   连接板子与PC，进入Dos命令行，进入C:\Program Files <x86>\STMicroelectronics\STM32 ST-LINK Utility\ST-LINK Utility目录下，执行ST-Link_CLI.exe -c SWD UR -OB RDP=0  这样就可以把读保护去掉了。</x86></li>
</ol>
<h2 id="2-网上有价值的信息"><a href="#2-网上有价值的信息" class="headerlink" title="2. 网上有价值的信息"></a>2. 网上有价值的信息</h2><p>　　很多人都碰到过调试器不能连接到STM32的问题，不管是IAR的J-Link还是Keil的ULink，或者是ST的ST-Link。出现这个问题时，调试软件会提示不能建立与Cortex-M3的连接，或提示不能下载程序，或提示找不到要调试的设备等。<br>这样的问题都是发生在调试那些可以在CPU不干预的时候自动运行的模块、或在调试低功耗模式的程序的时候。所谓“可以在CPU不干预的时候自动运行的模块”包括：DMA、定时器、连续转换模式下的ADC、看门狗等模块。</p>
<p>　　这个问题的根源是：</p>
<ol>
<li>调试器需要在RAM内执行一段程序，对Flash进行擦写操作，如果不停止这些自动运行的模块，它们会干扰程序在RAM中的执行，致使下载失败。比如DMA模块被配置为不停地拷贝一段数据区，而调试器刚好需要使用DMA数据传输的目标区域，这时DMA的操作将会与调试器的操作发生冲突。再比如，如果启动了看门狗而没有执行硬件复位，则在下次调试器需要下载程序时，看门狗超时将触发芯片复位，导致下载操作失败。</li>
<li>低功耗是通过停止CPU的时钟而实现，JTAG调试是通过与CPU的通信实现，停止了CPU的时钟致使调试器会失去与CPU的通信。</li>
</ol>
<p>　　有人说“我停止调试的时候，这些模块已经停止了运行，应该不会干扰到后续的调试”，这个问题要从几方面看：</p>
<ol>
<li>调试器是通过停止CPU核心的时钟来停止被调试程序的运行，实际上被调试芯片的硬件模块并没有被复位，它们还处于使能状态，那些能够自动运行的模块只是处于暂停状态，一旦恢复了时钟之后，它们仍会继续运行。</li>
<li>目前常用的调试软件，不管是IAR EWARM还是Keil MDK，调试软件界面上的”复位”按钮都不能对芯片执行硬件的复位，这个”复位”按钮只能对芯片内的程序执行软件复位，即把运行指针重新指向复位地址。</li>
<li>使用板上的复位按钮可以手动地进行硬件复位，使所有模块(包括那些能够自动运行的模块)停止工作并恢复到复位状态。但是当调试器需要控制CPU之前，它需要先为CPU核心提供时钟，然后需要较长的一段时间做一些初始化的动作，然后才能接管CPU核心的控制权。在调试器为CPU核心提供时钟之后，用户程序就已经开始运行起来，如果用户程序在调试器接管CPU核心的控制权之前，就初始化好硬件模块并启动运行，则仍然会产生与调试器的冲突。</li>
</ol>
<p>　　根据以上的分析，解决这个问题的关键是，在调试器接管CPU核心的控制权之前，必须停止所有能够自动运行模块的操作，使它们处于关闭状态，要做到这一点，可以有以下几种方案：</p>
<ol>
<li>每次退出调试状态时，先停止所有模块的运行，比如执行该模块的DeInit()操作。</li>
<li>在main()函数开始时，不管各模块处于什么状态，先执行该模块的DeInit()操作，然后在程序中较晚的时间或真正需要时再开启相应的模块。这样保证在刚进入调试状态时，调试器能够有充足的时间完成初始化和下载程序的操作。先执行该模块的DeInit()操作的目的是为了关闭哪些上一次操作开启的模块。</li>
<li>调整BOOT0/BOOT1的设置，把启动模式改变为从内部SRAM启动，再结合手工硬件复位。由于BOOT0/BOOT1的状态只在硬件复位时是有意义的，而调试器不做硬件复位，所以这样的设置不会影响调试器下载程序到Flash中，也不会影响在Flash中调试程序。</li>
</ol>
<h2 id="3-调试STM32程序时，某些标志位被调试软件意外清除的问题"><a href="#3-调试STM32程序时，某些标志位被调试软件意外清除的问题" class="headerlink" title="3. 调试STM32程序时，某些标志位被调试软件意外清除的问题"></a>3. 调试STM32程序时，某些标志位被调试软件意外清除的问题</h2><p>　　在调试的过程中，使用调试软件的寄存器或存储器显示窗口，可以很方便地查看外设寄存器的状态。<br>很多朋友都碰到过这样的问题：在单步调试时始终不能在显示窗口看到某些标志位的变化，应该设置这些标志位的时候，窗口中却显示为0，不少人都错误地认为这是芯片的问题。<br>　　我们知道，不少STM32外设的状态寄存器位，可以通过对某些寄存器的读操作而清除(例如I2C的I2C_SR1中的很多标志位)，在调试过程中，每当程序停止在设置的断点或单步停止时，调试软件都会自动地读出所有指定的寄存器和存储器中的内容，并刷新窗口的显示，调试软件的这个读操作恰好清除了那些标志位，造成了上面描述的现象。<br>有几个简单的办法解决这个问题：</p>
<ol>
<li>关闭寄存器或存储器显示窗口。 </li>
<li>在寄存器或存储器显示窗口中不显示这些敏感的寄存器。 </li>
<li>不要把断点放在对这些敏感的寄存器位操作的前面，以保证这些寄存器位不被调试软件意外地操作。 </li>
<li>看官自己添加<del>~</del></li>
</ol>
<p>　　在使用STM32的外设时，由于IO口被用作复用功能，但是外设的初始化正确，GPIO口初始化正确，外设的时钟也已开启，但是外设无法正常运行<br>　　其中最关键的一项，大多数使用者多没有设置，就是某个IO口被用作外设的接口时，需要开启IO口的复用功能的时钟，即进行外设、IO的时钟使能时，需要如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOx | RCC_APB2Periph_AFIO, ENABLE);</div><div class="line">/* GPIOx and AFIO clock enable */</div></pre></td></tr></table></figure><br> 　　在使用时，一定要注意该要点！</p>
<h2 id="4-其他关键问题"><a href="#4-其他关键问题" class="headerlink" title="4. 其他关键问题"></a>4. 其他关键问题</h2><p>　　在实际操作过程中，还有两个最关键的地方，一是ST-LINK网上买的都是山寨货，很不稳定，默认频率4M，可以改成1.8M试一试；二是不要使用USB延迟线，会有不稳定的现象。
 　　</p>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/其他/">其他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/硬件/">硬件</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/硬件/stm32/">stm32</a><span class="category-list-count">1</span></li></ul></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/sw连接/" style="font-size: 10px;">sw连接</a> <a href="/tags/格式说明/" style="font-size: 10px;">格式说明</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/06/21/树莓派P3设置静态IP/">树莓派P3设置静态IP</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/21/STM32L052的CRC8硬件实现/">STM32L052的CRC8硬件实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/21/STM32的ADC测量电压/">STM32的ADC测量电压</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/21/STM32-Spi-DMA/">STM32 Spi DMA</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/21/STM32f103-uart-dma-printf串口终极方案/">STM32f103 uart dma printf串口终极方案</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2017/06/21/STM32L0-Lorawan调试问题/" class="prev">上一篇</a><a href="/2017/06/21/STM32去掉flash读保护/" class="next">下一篇</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script>var cloudTieConfig = {
    url: document.location.href, 
    sourceId: "",
    productKey: "656e246ebfc7420d82eb5d9a339b50c2",
    target: "cloud-tie-wrapper"
};</script><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><div class="copyright"><p>© 2016 - 2017 <a target="_blank">wuyaxiong</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a>.</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>